-- PARTIE 3 : Vues
Créer des vues permettant d'avoir les informations suivantes :

1. Les moniteurs avec leur nombre d'heures de leçons.
Schéma : MONITEURS_ET_LECONS (m_id, m_nom, m_prenom, total_heures)

CREATE VIEW MONITEURS_ET_LECONS AS
SELECT m.m_id, m.m_nom, m.m_prenom, SUM(l.l_duree) AS total_heures
FROM moniteur m
JOIN lecon l ON m.m_id = l.m_id
GROUP BY m.m_id, m.m_nom, m.m_prenom;

2. Le(s) moniteur(s) qui a(/ont) le moins d'heures de leçons
Schéma : MONITEURS_MIN_HEURES (m_id, m_nom, m_prenom)

CREATE VIEW MONITEURS_MIN_HEURES AS
SELECT m.m_id, m.m_nom, m.m_prenom
FROM moniteur m
JOIN lecon l ON m.m_id = l.m_id
GROUP BY m.m_id, m.m_nom, m.m_prenom
HAVING SUM(l.l_duree) = (SELECT MIN(total_heures) FROM 
                        (SELECT SUM(l_duree) AS total_heures 
                         FROM lecon 
                         GROUP BY m_id));

3. Les élèves avec le nombre de kilomètres parcourus par type de voie, et le nombre total de kilomètres parcourus.
Schéma : ELEVES_AVEC_TRAJETS (e_id, e_nom, e_prenom, nb_route, nb_autoroute, nb_ville, nb_total_km)

CREATE VIEW ELEVES_AVEC_TRAJETS AS
SELECT e.e_id, e.e_nom, e.e_prenom,
       SUM(CASE WHEN t.t_type = 'Route' THEN t.t_nb_km ELSE 0 END) AS nb_route,
       SUM(CASE WHEN t.t_type = 'Autoroute' THEN t.t_nb_km ELSE 0 END) AS nb_autoroute,
       SUM(CASE WHEN t.t_type = 'Ville' THEN t.t_nb_km ELSE 0 END) AS nb_ville,
       SUM(t.t_nb_km) AS nb_total_km
FROM eleve e
JOIN trajet t ON e.e_id = t.e_id
GROUP BY e.e_id, e.e_nom, e.e_prenom;

4. Les élèves qui ont déjà passé le permis (en l'ayant raté) mais pas depuis 1 an.
Schéma : ELEVES_A_FAIRE_REPASSER (e_id, e_nom, e_prenom, date_dernier_passage)

CREATE VIEW ELEVES_A_FAIRE_REPASSER AS
SELECT e.e_id, e.e_nom, e.e_prenom, MAX(i.i_date_examen) AS date_dernier_passage
FROM eleve e
JOIN inscription i ON e.e_id = i.e_id
WHERE i.i_resultat = 'Échoué'
GROUP BY e.e_id, e.e_nom, e.e_prenom;

5. Les élèves qui n'ont pas passé l'examen depuis 1 an, ou qui n'ont jamais passé l'examen mais sont inscrits depuis au 
moins 1 an. C'est à dire tous les élèves de la vue précédente, auxquels ont ajoute ceux qui n'ont jamais passé le permis.
Schéma : ELEVES_A_FAIRE_PASSER (e_id, e_nom, e_prenom

CREATE VIEW ELEVES_A_FAIRE_PASSER AS
SELECT e.e_id, e.e_nom, e.e_prenom
FROM eleve e
LEFT JOIN inscription i ON e.e_id = i.e_id
WHERE (i.i_date_examen IS NULL AND e.e_date_dossier <= SYSDATE - INTERVAL '1' YEAR)
   OR (i.i_date_examen IS NOT NULL AND i.i_date_examen <= SYSDATE - INTERVAL '1' YEAR)
   OR (i.i_date_examen IS NULL AND e.e_date_dossier <= SYSDATE - INTERVAL '1' YEAR AND i.i_id IS NULL);
